trigger:
  branches:
    include:
      - main

stages:
- stage: Deploy
  displayName: Deploy to AKS
  jobs:
  - job: HelmDeploy
    pool:
      vmImage: "ubuntu-latest"
    steps:
    - task: AzureCLI@2
      displayName: "Login to Azure & AKS"
      inputs:
        azureSubscription: "YOUR-AZURE-SERVICE-CONNECTION"
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          az aks get-credentials \
            --resource-group cloudwise-rg \
            --name cloudwise-aks \
            --overwrite-existing

          helm upgrade --install cloudwise helm/cloudwise-chart \
            --set image.repository=${ACR_LOGIN_SERVER}/cloudwise-it \
            --set image.tag=latest
